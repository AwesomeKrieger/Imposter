<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="icon" type="image/png" href="https://raw.githubusercontent.com/AwesomeKrieger/Imposter/refs/heads/main/AppIcon%7Eios-marketing.png">      
<link rel="apple-touch-icon" href="https://raw.githubusercontent.com/AwesomeKrieger/Imposter/refs/heads/main/AppIcon%7Eios-marketing.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <title>IMPOSTER</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { 
        background-color: #ffffff; color: #000; 
        font-family: -apple-system, sans-serif; 
        margin: 0; padding: 0;
        height: 100%; width: 100%;
        overflow: hidden; 
    }

    .main-container { 
        height: 100dvh; 
        display: flex; 
        flex-direction: column; 
        padding: 1rem; 
        box-sizing: border-box;
    }

    .game-card { 
        width: 100%; 
        max-width: 400px; 
        margin: 0 auto;
        display: flex; 
        flex-direction: column; 
        height: 100%; 
        overflow: hidden; 
    }

    .scroll-container { 
        flex: 1; 
        overflow-y: auto !important; 
        -webkit-overflow-scrolling: touch; 
        border: 4px solid black; 
        background: #fafafa; 
        touch-action: pan-y; 
        min-height: 0; 
    }

    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .neo-box { border: 4px solid #000; box-shadow: 6px 6px 0px 0px #000; }
    .progress-fill { height: 100%; background: #ef4444; transition: width 0.4s ease-out; width: 0%; }
</style>


</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const GITHUB_TOPICS_URL = "https://raw.githubusercontent.com/AwesomeKrieger/Imposter/main/topics.json";
        const AI_MODEL = "gemini-2.5-flash-lite"; 


        const App = () => {
            const [data, setData] = useState(null);
            const [aiWordPool, setAiWordPool] = useState(() => {
                const saved = localStorage.getItem('imp_word_pool_v1');
                return saved ? JSON.parse(saved) : {};
            });

            const [groups, setGroups] = useState([]);
            const [selectedGroup, setSelectedGroup] = useState("BELIEBT");
            const [subCats, setSubCats] = useState([]);
            const [selectedSubs, setSelectedSubs] = useState([]);
            
            const [gameState, setGameState] = useState('setup'); 
            const [players, setPlayers] = useState(['Spieler 1', 'Spieler 2', 'Spieler 3']);
            const [imposterCount, setImposterCount] = useState(1);
            const [showHint, setShowHint] = useState(false);
            const [timerMinutes, setTimerMinutes] = useState(0);
            const [timeLeft, setTimeLeft] = useState(0);
            const [stats, setStats] = useState({});

            const [apiKey, setApiKey] = useState(() => localStorage.getItem('imp_key') || '');
            const [customTopics, setCustomTopics] = useState(() => {
                const saved = localStorage.getItem('imp_custom_v12');
                return saved ? JSON.parse(saved) : [];
            });
            
            const [loading, setLoading] = useState(false);
            const [visualProgress, setVisualProgress] = useState(0);
            const [gameData, setGameData] = useState({ word: "", hint: "", imposterIndices: [], currentPlayer: 0, showingWord: false, chaosMode: "" });

            useEffect(() => {
                let interval;
                if (gameState === 'play' && timeLeft > 0) {
                    interval = setInterval(() => setTimeLeft(prev => Math.max(0, prev - 1)), 1000);
                }
                return () => clearInterval(interval);
            }, [gameState, timeLeft]);

            useEffect(() => {
                fetch(GITHUB_TOPICS_URL).then(res => res.json()).then(json => {
                    setData(json);
                    setGroups(["BELIEBT", "EIGENE", ...Object.keys(json)]);
                    updateView("BELIEBT", json, customTopics);
                });
            }, []);

            useEffect(() => {
                localStorage.setItem('imp_word_pool_v1', JSON.stringify(aiWordPool));
            }, [aiWordPool]);

            const updateView = (groupName, fullData = data, currentCustom = customTopics) => {
    if (!fullData) return;
    setSelectedGroup(groupName);
    let list = [];
    if (groupName === "BELIEBT") {
        Object.keys(fullData).forEach(g => Object.keys(fullData[g]).forEach(s => list.push({ name: s, parent: g })));
        list = list.sort(() => 0.5 - Math.random()).slice(0, 4);
    } else if (groupName === "EIGENE") {
        list = currentCustom.map(t => ({ name: t.name, parent: "EIGENE" }));
    } else {
        Object.keys(fullData[groupName]).forEach(s => list.push({ name: s, parent: groupName }));
    }
    setSubCats(list);
};

            const toggleSub = (name) => {
                setSelectedSubs(prev => 
                    prev.includes(name) ? prev.filter(n => n !== name) : [...prev, name]
                );
            };

            const selectAll = () => {
                const currentNames = subCats.map(s => s.name);
                const allCurrentSelected = currentNames.every(name => selectedSubs.includes(name));
                if (allCurrentSelected) {
                    setSelectedSubs(prev => prev.filter(name => !currentNames.includes(name)));
                } else {
                    setSelectedSubs(prev => [...new Set([...prev, ...currentNames])]);
                }
            };

            const resetAll = () => {
                if(confirm("Alle ausgew√§hlten Themen l√∂schen?")) {
                    setSelectedSubs([]);
                }
            };

            const addCustomTopic = () => {
                const name = prompt("Gib ein Thema f√ºr die KI ein:");
                if(name && name.trim() !== "") {
                    const newList = [...customTopics, { name: name.trim() }];
                    setCustomTopics(newList);
                    localStorage.setItem('imp_custom_v12', JSON.stringify(newList));
                    const newSubList = newList.map(t => ({ name: t.name, parent: "EIGENE" }));
                    setSubCats(newSubList);
                    setSelectedSubs([name.trim()]);
                }
            };

            const startGame = async () => {
                if(selectedGroup === "EIGENE" && !apiKey) return alert("API Key fehlt!");
                if(selectedSubs.length === 0) return alert("Mindestens ein Thema w√§hlen!");

                setLoading(true);
                setVisualProgress(50);
                const randomSub = selectedSubs[Math.floor(Math.random() * selectedSubs.length)];
                let word = "", hint = "", chaos = "";
                let indices = [];

                try {
                    const rng = Math.random();
                    if (rng < 0.05) chaos = "ALL";
                    else if (rng < 0.10) chaos = "NONE";

                    if (selectedGroup === "EIGENE") {
    if (aiWordPool[randomSub] && aiWordPool[randomSub].length > 0) {
        const nextPair = aiWordPool[randomSub][0];
        word = nextPair.word;
        hint = nextPair.hint;
        setAiWordPool(prev => ({ ...prev, [randomSub]: prev[randomSub].slice(1) }));
    } else {
        const promptText = `Du bist ein Spiel-Master. Thema: "${randomSub}". Generiere 10 verschiedene, spezifische Wort-Paare. Format: Wort|Hinweis (jeweils 1 Wort). Trenne die Paare mit Komma. Beispiel: Apfel|Obst, Auto|Motor. Antworte NUR mit der Liste.`;
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${AI_MODEL}:generateContent?key=${apiKey}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
        });
        const d = await res.json();
        const raw = d.candidates[0].content.parts[0].text.trim().replace(/```/g, "");
        const pairs = raw.split(',').map(p => {
            const [w, h] = p.split('|');
            return { word: w.trim(), hint: h ? h.trim() : "Aktion" };
        });
        word = pairs[0].word;
        hint = pairs[0].hint;
        setAiWordPool(prev => ({ ...prev, [randomSub]: pairs.slice(1) }));
    }
} else {
    // F√ºr normale Kategorien aus JSON laden
    const parentGroup = subCats.find(s => s.name === randomSub)?.parent;
    if (parentGroup && data[parentGroup] && data[parentGroup][randomSub]) {
        const topicData = data[parentGroup][randomSub];
        if (topicData.pairs && Array.isArray(topicData.pairs) && topicData.pairs.length > 0) {
            const randomPair = topicData.pairs[Math.floor(Math.random() * topicData.pairs.length)];
            word = randomPair[0];  // Erstes Element = Wort
            hint = randomPair[1];  // Zweites Element = Hinweis
        }
    }
}


                    if (chaos === "ALL") {
                        indices = players.map((_, i) => i);
                    } else if (chaos === "NONE") {
                        indices = [];
                    } else {
                        const count = Math.min(imposterCount, players.length - 1);
                        while(indices.length < count) {
                            let r = Math.floor(Math.random() * players.length);
                            if(!indices.includes(r)) indices.push(r);
                        }
                    }

                    const newStats = { ...stats };
                    indices.forEach(idx => { newStats[players[idx]] = (newStats[players[idx]] || 0) + 1; });
                    setStats(newStats);
                    setGameData({ word, hint, imposterIndices: indices, currentPlayer: 0, showingWord: false, chaosMode: chaos });
                    setTimeLeft(timerMinutes * 60);
                    setVisualProgress(100);
                    setTimeout(() => { setGameState('reveal'); setLoading(false); }, 400);
                } catch (e) { alert("Fehler!"); setLoading(false); }
            };

            const formatTime = (s) => `${Math.floor(s/60)}:${(s%60).toString().padStart(2, '0')}`;

            if (!data) return <div className="h-screen flex items-center justify-center font-black">Lade...</div>;

            return (
                <div className="main-container">
                    <h1 className="text-4xl font-black italic mb-4 border-b-8 border-red-600 tracking-tighter shrink-0 uppercase">Imposter.ai</h1>

                    <div className="game-card bg-white p-5 neo-box space-y-4">
                        {loading ? (
                             <div className="flex flex-col items-center justify-center p-10 space-y-4">
                                <div className="font-black text-xl italic uppercase">Generiere...</div>
                                <div className="w-full border-4 border-black h-8 bg-white"><div className="progress-fill" style={{width: `${visualProgress}%`}}></div></div>
                            </div>
                        ) : gameState === 'setup' ? (
                            <>
                                <div className="grid grid-cols-3 gap-2 shrink-0">
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-black uppercase opacity-60">Verr√§ter:</label>
                                        <select value={imposterCount} onChange={e => setImposterCount(parseInt(e.target.value))} className="w-full p-2 border-2 border-black font-bold text-xs bg-white outline-none">
                                            {Array.from({length: players.length - 1}, (_, i) => i + 1).map(n => <option key={n} value={n}>{n}</option>)}
                                        </select>
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-black uppercase opacity-60">Hinweis:</label>
                                        <button onClick={() => setShowHint(!showHint)} className={`w-full p-2 border-2 border-black font-bold text-[10px] uppercase transition-colors ${showHint ? 'bg-green-400' : 'bg-red-400'}`}>
                                            {showHint ? 'AN' : 'AUS'}
                                        </button>
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-black uppercase opacity-60">Zeitlimit:</label>
                                        <select value={timerMinutes} onChange={e => setTimerMinutes(parseInt(e.target.value))} className="w-full p-2 border-2 border-black font-bold text-xs bg-white outline-none">
                                            {[0,1,2,3,5,10].map(m => <option key={m} value={m}>{m === 0 ? "AUS" : `${m}min`}</option>)}
                                        </select>
                                    </div>
                                </div>

                                <div className="space-y-2 pt-2 shrink-0">
                                    <div className="flex justify-between items-center">
                                        <span className="font-black text-[10px] uppercase underline">Mitspieler:</span>
                                        <button onClick={() => players.length < 10 && setPlayers([...players, `Spieler ${players.length+1}`])} className="bg-green-500 text-white px-2 py-1 neo-box text-[10px] font-black uppercase">+ Add</button>
                                    </div>
                                    <div className="grid grid-cols-2 gap-1 max-h-24 overflow-y-auto border border-black p-1 bg-gray-50">
                                        {players.map((p, i) => (
                                            <div key={i} className="flex border border-black bg-white">
                                                <input value={p} onChange={e => {let n=[...players]; n[i]=e.target.value; setPlayers(n);}} className="w-full p-1 text-[10px] font-bold outline-none uppercase" />
                                                <span className="text-[9px] font-black bg-yellow-400 px-1 border-l border-black flex items-center">üïµÔ∏è{stats[p] || 0}</span>
                                                <button onClick={() => players.length > 3 && setPlayers(players.filter((_, idx) => idx !== i))} className="bg-red-500 text-white px-1 font-black">√ó</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="flex gap-2 overflow-x-auto pb-2 hide-scrollbar border-t-2 border-black pt-2 shrink-0">
                                    {groups.map(g => {
                                        const hasSelection = data && data[g] && Object.keys(data[g]).some(s => selectedSubs.includes(s));
                                        const isCustomSelection = g === "EIGENE" && customTopics.some(t => selectedSubs.includes(t.name));
                                        return (
                                            <button key={g} onClick={() => updateView(g)} className={`px-3 py-2 border-2 border-black font-black text-[10px] uppercase whitespace-nowrap transition-all ${selectedGroup === g ? 'bg-red-600 text-white' : (hasSelection || isCustomSelection ? 'bg-yellow-300 text-black' : 'bg-white text-black')}`}>
                                                {g} {(hasSelection || isCustomSelection) && "‚óè"}
                                            </button>
                                        );
                                    })}
                                </div>

                                <div className="sticky top-0 z-10 flex border-b-4 border-black bg-white shrink-0">
                                    <button onClick={selectAll} className="flex-1 p-3 bg-yellow-400 font-black text-[10px] uppercase hover:bg-yellow-500 border-r-4 border-black transition-all active:bg-yellow-600">
                                        {subCats.length > 0 && subCats.every(s => selectedSubs.includes(s.name)) ? "√ó Abw√§hlen" : "‚úì Alle (Gruppe)"}
                                    </button>
                                    <button onClick={resetAll} className="w-1/3 p-3 bg-red-500 text-white font-black text-[10px] uppercase hover:bg-red-600 transition-all active:bg-red-800">
                                        Reset ({selectedSubs.length})
                                    </button>
                                </div>

                                <div className="scroll-container hide-scrollbar my-2">
                                    {selectedGroup === "EIGENE" && (
                                        <button onClick={addCustomTopic} className="w-full p-4 border-b-4 border-dashed border-black font-black text-sm uppercase bg-yellow-100 hover:bg-yellow-200 transition-colors">
                                            + NEUES KI-THEMA
                                        </button>
                                    )}
                                    {subCats.map(s => (
                                        <button key={s.name} onClick={() => toggleSub(s.name)} className={`w-full p-4 border-b-2 border-black font-black text-left text-sm uppercase transition-colors ${selectedSubs.includes(s.name) ? 'bg-black text-white' : 'bg-white'}`}>
                                            {selectedSubs.includes(s.name) ? "‚úì " : ""}{s.name}
                                        </button>
                                    ))}
                                </div>

                                <button onClick={startGame} className="w-full bg-red-600 text-white font-black py-4 text-2xl neo-box shrink-0 active:bg-red-700 uppercase">
                                    {selectedSubs.length > 0 ? `Start (${selectedSubs.length})` : 'Thema w√§hlen'}
                                </button>

                                <input type="password" placeholder="API Key..." className="w-full p-1 text-[8px] border-b opacity-10 shrink-0" value={apiKey} onChange={e => {setApiKey(e.target.value); localStorage.setItem('imp_key', e.target.value);}} />
                            </>
                        ) : (
                            <div className="p-4 text-center">
                                {gameState === 'reveal' && (
                                    <div className="space-y-6 py-4 flex flex-col items-center">
                                        <h2 className="text-2xl font-black uppercase italic border-b-4 border-black px-4">{players[gameData.currentPlayer]}</h2>
                                        <div onClick={() => setGameData({...gameData, showingWord: true})} 
                                             className={`w-full h-64 flex flex-col items-center justify-center border-4 border-black p-6 
                                             ${gameData.showingWord ? (gameData.imposterIndices.includes(gameData.currentPlayer) ? 'bg-black text-white' : 'bg-red-600 text-white') : 'bg-gray-100 animate-pulse'}`}>
                                            {gameData.showingWord ? (
                                                gameData.imposterIndices.includes(gameData.currentPlayer) ? (
                                                    <div className="text-center">
                                                        <div className="text-red-500 font-black text-xl mb-1 uppercase tracking-widest">Du bist der</div>
                                                        <div className="text-6xl font-black uppercase italic">Imposter</div>
                                                        {showHint && <div className="mt-6 p-3 border-2 border-white text-sm font-bold uppercase">Tipp: {gameData.hint}</div>}
                                                    </div>
                                                ) : <span className="text-5xl font-black uppercase tracking-tighter text-center">{gameData.word}</span>
                                            ) : <span className="text-2xl font-black italic underline uppercase text-black">Karte aufdecken</span>}
                                        </div>
                                        {gameData.showingWord && (
                                            <button onClick={() => {
                                                if(gameData.currentPlayer + 1 < players.length) setGameData({...gameData, currentPlayer: gameData.currentPlayer + 1, showingWord: false});
                                                else setGameState('play');
                                            }} className="w-full bg-black text-white py-4 font-black text-xl neo-box uppercase">Verstanden</button>
                                        )}
                                    </div>
                                )}
                                {gameState === 'play' && (
                                    <div className={`py-12 flex flex-col items-center space-y-8 h-full ${timeLeft === 0 && timerMinutes > 0 ? 'timer-warn' : ''}`}>
                                        {timerMinutes > 0 && <div className="text-6xl font-black px-6 py-2 border-4 border-black neo-box shadow-[8px_8px_0px_0px_rgba(0,0,0,1)]">{formatTime(timeLeft)}</div>}
                                        <h2 className="text-6xl font-black text-red-600 italic animate-bounce uppercase">Diskussion!</h2>
                                        <button onClick={() => setGameState('finish')} className="w-full bg-black text-white py-6 font-black text-2xl neo-box uppercase">Aufl√∂sen</button>
                                    </div>
                                )}
                                {gameState === 'finish' && (
                                    <div className="py-10 flex flex-col items-center space-y-6 text-center">
                                        <h2 className="text-2xl font-black uppercase underline decoration-4">
                                            {gameData.chaosMode === "ALL" ? "PARANOIA! Alle Imposter!" : 
                                             gameData.chaosMode === "NONE" ? "FEHLALARM! Niemand!" : "Die Verr√§ter:"}
                                        </h2>
                                        {gameData.imposterIndices.length > 0 ? gameData.imposterIndices.map(idx => (
                                            <div key={idx} className="text-4xl font-black text-red-600 italic uppercase tracking-tighter">{players[idx]}</div>
                                        )) : <div className="text-4xl font-black text-green-600 italic uppercase">Niemand</div>}
                                        <div className="text-lg font-bold bg-gray-100 p-4 border-2 border-black uppercase mt-4">Das Wort: {gameData.word}</div>
                                        <button onClick={() => setGameState('setup')} className="w-full bg-red-600 text-white py-5 font-black text-xl neo-box uppercase">N√§chste Runde</button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
